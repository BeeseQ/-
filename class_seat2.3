<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šåº§ä½è¡¨ - æŒ‡å®šåº§ä½æœ€çµ‚é€²éšç‰ˆ</title>
    <style>
        :root {
            --boy-color: #e3f2fd;
            --boy-text: #1565c0;
            --girl-color: #fff1f2;
            --girl-text: #be123c;
            --label-bg: #475569;
            --accent: #f59e0b; /* æŒ‡å®šåº§ä½çš„é¡è‰² */
            --front-accent: #0ea5e9; /* è¦–åŠ›å„ªå…ˆçš„é¡è‰² */
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f1f5f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; width: 100%; max-width: 700px; border: 1px solid #e2e8f0; }
        .control-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0; }
        .control-title { font-weight: bold; margin-bottom: 8px; color: #1e293b; display: flex; align-items: center; gap: 5px; }
        
        .input-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
        input, select { padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; }
        .num-input { width: 50px; }
        .text-input { width: 250px; text-align: left; }

        .btn-add { background-color: #64748b; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        .btn-del { background-color: #ef4444; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .btn-main { background-color: #2563eb; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; width: 100%; transition: 0.2s; margin-top: 10px; }
        .btn-main:hover { background-color: #1d4ed8; }

        .blackboard { width: 100%; max-width: 600px; background: #334155; color: white; text-align: center; padding: 12px; font-size: 1.4em; font-weight: bold; border-radius: 4px; margin-bottom: 30px; }
        .classroom-container { display: flex; gap: 50px; justify-content: center; align-items: flex-start; }
        .column { display: flex; flex-direction: column; gap: 20px; }
        .group-box { background: white; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .seats-grid { display: grid; gap: 6px; }
        .grid-2x2 { grid-template-columns: repeat(2, 60px); }
        .grid-3-2 { grid-template-columns: repeat(3, 60px); }

        .seat { width: 60px; height: 60px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; border: 1px solid rgba(0,0,0,0.1); position: relative; }
        .seat span { font-size: 0.65em; font-weight: normal; margin-bottom: 2px; color: #64748b; }
        
        .boy { background-color: var(--boy-color); color: var(--boy-text); }
        .girl { background-color: var(--girl-color); color: var(--girl-text); }
        
        .group-label { background: var(--label-bg); color: white; padding: 8px 4px; font-size: 0.9em; writing-mode: vertical-rl; text-orientation: upright; border-radius: 4px; letter-spacing: 2px; }
        .label-left { margin-right: 10px; }
        .label-right { margin-left: 10px; }
        
        /* è¦–è¦ºæ¨™è¨˜ */
        .mark-fixed { outline: 3px solid var(--accent); z-index: 1; }
        .mark-fixed::before { content: "ğŸ“Œ"; position: absolute; top: -10px; right: -5px; font-size: 12px; }
        .mark-front { outline: 2px solid var(--front-accent); }
        .mark-front::before { content: "ğŸ‘“"; position: absolute; top: -10px; right: -5px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="controls">
        <div class="control-section">
            <div class="control-title">ğŸ“Œ æŒ‡å®šå­¸ç”Ÿåº§ä½</div>
            <div id="fixed-list">
                </div>
            <button class="btn-add" onclick="addFixedRow()">ï¼‹ æ–°å¢æŒ‡å®šåº§ä½</button>
        </div>

        <div class="control-section">
            <div class="control-title">ğŸ‘“ è¦–åŠ›å„ªå…ˆï¼ˆç¬¬ä¸€ã€å…­çµ„åº§ä½ï¼‰</div>
            <input type="text" id="front-row-input" class="text-input" placeholder="è¼¸å…¥åº§è™Ÿï¼Œç”¨ç©ºæ ¼éš”é–‹ (å¦‚: 5 18)">
        </div>

        <div class="control-section">
            <div class="control-title">ğŸš« å¤šå°é¿é–‹åå–®</div>
            <div id="pair-list">
                <div class="input-row">
                    <input type="number" class="p1 num-input"> <span>ä¸èˆ‡</span> <input type="number" class="p2 num-input"> <span>åŒçµ„</span>
                    <button class="btn-del" onclick="this.parentElement.remove()">âœ•</button>
                </div>
            </div>
            <button class="btn-add" onclick="addPairRow()">ï¼‹ æ–°å¢é¿é–‹çµ„åˆ</button>
        </div>

        <button class="btn-main" onclick="generate()">ğŸ”€ é–‹å§‹éš¨æ©Ÿæ’åº§</button>
    </div>

    <div class="blackboard">é»‘æ¿ (é›»å­å¤§å±)</div>
    <div class="classroom-container">
        <div class="column" id="left-col"></div>
        <div class="column" id="right-col"></div>
    </div>

<script>
const GENDER_RULES = { 'A': 'girl', 'B': 'boy', 'C': 'boy', 'D': 'girl', 'E': 'boy' };

function addFixedRow() {
    const container = document.getElementById('fixed-list');
    const row = document.createElement('div');
    row.className = 'input-row';
    row.innerHTML = `
        <span>åº§è™Ÿ</span><input type="number" class="fix-num num-input">
        <span>åˆ†é…åˆ°</span>
        <select class="fix-group"><option value="ä¸€">ç¬¬ä¸€çµ„</option><option value="äºŒ">ç¬¬äºŒçµ„</option><option value="ä¸‰">ç¬¬ä¸‰çµ„</option><option value="å››">ç¬¬å››çµ„</option><option value="äº”">ç¬¬äº”çµ„</option><option value="å…­">ç¬¬å…­çµ„</option></select>
        <select class="fix-pos"><option value="A">ä½ç½® A (å¥³)</option><option value="B">ä½ç½® B (ç”·)</option><option value="C">ä½ç½® C (ç”·)</option><option value="D">ä½ç½® D (å¥³)</option><option value="E">ä½ç½® E (ç”·,é™ç¬¬3çµ„)</option></select>
        <button class="btn-del" onclick="this.parentElement.remove()">âœ•</button>`;
    container.appendChild(row);
}

function addPairRow() {
    const container = document.getElementById('pair-list');
    const row = document.createElement('div');
    row.className = 'input-row';
    row.innerHTML = `<input type="number" class="p1 num-input"> <span>ä¸èˆ‡</span> <input type="number" class="p2 num-input"> <span>åŒçµ„</span> <button class="btn-del" onclick="this.parentElement.remove()">âœ•</button>`;
    container.appendChild(row);
}

function generate() {
    // æ”¶é›†æŒ‡å®šåº§ä½
    const fixedSeats = {}; // æ ¼å¼: { "ä¸€_A": 15 }
    const fixedStudents = new Set();
    let genderError = false;

    document.querySelectorAll('#fixed-list .input-row').forEach(row => {
        const num = parseInt(row.querySelector('.fix-num').value);
        const group = row.querySelector('.fix-group').value;
        const pos = row.querySelector('.fix-pos').value;
        if (!isNaN(num)) {
            const gender = num <= 13 ? 'boy' : 'girl';
            if (GENDER_RULES[pos] !== gender) { genderError = `åº§è™Ÿ ${num} æ€§åˆ¥èˆ‡ä½ç½® ${pos} ä¸ç¬¦`; }
            if (pos === 'E' && group !== 'ä¸‰') { genderError = `ä½ç½® E åƒ…é™ç¬¬ä¸‰çµ„`; }
            fixedSeats[`${group}_${pos}`] = num;
            fixedStudents.add(num);
        }
    });

    if (genderError) { alert(genderError); return; }

    // æ”¶é›†å…¶é¤˜åå–®
    const frontInput = document.getElementById('front-row-input').value;
    const frontRaw = frontInput.split(/[ ,]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && !fixedStudents.has(n));
    const pairRows = document.querySelectorAll('#pair-list .input-row');
    const restrictions = [];
    pairRows.forEach(row => {
        const v1 = parseInt(row.querySelector('.p1').value);
        const v2 = parseInt(row.querySelector('.p2').value);
        if (!isNaN(v1) && !isNaN(v2)) restrictions.push([v1, v2]);
    });

    let resultGroups = [];
    let attempts = 0;

    while (attempts < 2000) {
        attempts++;
        let boysPool = Array.from({length: 13}, (_, i) => i + 1).filter(n => !fixedStudents.has(n) && !frontRaw.includes(n));
        let girlsPool = Array.from({length: 12}, (_, i) => i + 14).filter(n => !fixedStudents.has(n) && !frontRaw.includes(n));
        const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
        shuffle(boysPool); shuffle(girlsPool);
        
        let curFrontBoys = frontRaw.filter(n => n <= 13);
        let curFrontGirls = frontRaw.filter(n => n > 13);
        shuffle(curFrontBoys); shuffle(curFrontGirls);

        let tempGroups = [];
        let conflict = false;
        const order = ['ä¸€', 'å…­', 'äºŒ', 'äº”', 'ä¸‰', 'å››'];

        for (let gId of order) {
            let res = { id: gId, seats: {} };
            let seatsToFill = (gId === 'ä¸‰') ? ['A','B','C','D','E'] : ['A','B','C','D'];
            
            for (let p of seatsToFill) {
                if (fixedSeats[`${gId}_${p}`]) {
                    res.seats[p] = fixedSeats[`${gId}_${p}`];
                } else {
                    const targetGender = GENDER_RULES[p];
                    const isFrontGroup = (gId === 'ä¸€' || gId === 'å…­');
                    if (targetGender === 'boy') {
                        res.seats[p] = (isFrontGroup && curFrontBoys.length > 0) ? curFrontBoys.pop() : boysPool.pop();
                    } else {
                        res.seats[p] = (isFrontGroup && curFrontGirls.length > 0) ? curFrontGirls.pop() : girlsPool.pop();
                    }
                }
            }

            const members = Object.values(res.seats);
            for (let [r1, r2] of restrictions) {
                if (members.includes(r1) && members.includes(r2)) { conflict = true; break; }
            }
            if (conflict) break;
            tempGroups.push(res);
        }

        if (!conflict && tempGroups.length === 6) {
            resultGroups = tempGroups;
            break;
        }
    }

    if (resultGroups.length === 0) alert("ç„¡æ³•ç”Ÿæˆï¼Œè«‹æª¢æŸ¥é™åˆ¶æ˜¯å¦éå¤šã€‚");
    else render(resultGroups, fixedStudents, frontRaw);
}

function render(groups, fixedSet, frontList) {
    const leftCol = document.getElementById('left-col');
    const rightCol = document.getElementById('right-col');
    leftCol.innerHTML = ''; rightCol.innerHTML = '';

    groups.forEach(g => {
        const box = document.createElement('div');
        box.className = 'group-box';
        const isLeft = ['ä¸€', 'äºŒ', 'ä¸‰'].includes(g.id);
        const label = `<div class="group-label ${isLeft ? 'label-left' : 'label-right'}">ç¬¬${g.id}çµ„</div>`;
        
        const getSeatHtml = (p) => {
            const num = g.seats[p];
            if (!num) return '<div></div>';
            const genderClass = num <= 13 ? 'boy' : 'girl';
            const markClass = fixedSet.has(num) ? 'mark-fixed' : (frontList.includes(num) ? 'mark-front' : '');
            return `<div class="seat ${genderClass} ${markClass}"><span>${p}</span>${num}</div>`;
        };

        let seatsHtml = '';
        if (g.id !== 'ä¸‰') {
            seatsHtml = `<div class="seats-grid grid-2x2">
                ${getSeatHtml('C')}${getSeatHtml('A')}
                ${getSeatHtml('D')}${getSeatHtml('B')}
            </div>`;
        } else {
            seatsHtml = `<div class="seats-grid grid-3-2">
                ${getSeatHtml('E')}${getSeatHtml('A')}${getSeatHtml('B')}
                <div></div>${getSeatHtml('C')}${getSeatHtml('D')}
            </div>`;
        }
        box.innerHTML = isLeft ? label + seatsHtml : seatsHtml + label;
        (isLeft ? leftCol : rightCol).appendChild(box);
    });
}

// åˆå§‹åŠ ä¸€åˆ—æŒ‡å®šåº§ä½
addFixedRow();
</script>

</body>
</html>
